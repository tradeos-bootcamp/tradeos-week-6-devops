# .github/workflows/cd.yml
name: CD Pipeline

on:
  push:
    branches: [ main ]
  tags: [ 'v*.*.*' ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Create .env file
        run: |
          echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" > .env
          echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
          echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> .env
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> .env
          echo "WORKERS=${{ secrets.WORKERS }}" >> .env
          cat .env
      
      - name: Copy files to server
        run: |
          scp -r .env docker-compose.prod.yml backend/ frontend/ scripts/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/opt/tradeos
      
      - name: Deploy on server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          cd /opt/tradeos
          # Pull latest images
          docker-compose -f docker-compose.prod.yml pull
          # Backup database before update
          ./scripts/backup.sh
          # Migrate database
          docker-compose -f docker-compose.prod.yml run --rm backend \
            alembic upgrade head
          # Restart services
          docker-compose -f docker-compose.prod.yml up -d --force-recreate
          # Cleanup old images
          docker image prune -f
          # Health check
          sleep 30
          curl -f http://localhost/health || exit 1
          EOF
      
      - name: Send notification
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: deployments
          SLACK_COLOR: good
          SLACK_TITLE: "✅ Deployment Successful"
          SLACK_MESSAGE: "TradeOS v${{ github.ref_name }} deployed to production"
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
